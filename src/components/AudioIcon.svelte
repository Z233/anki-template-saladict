<script>
  import { onMount } from 'svelte'
  import { isDev } from '../utils/helper'

  export let className = 'h-5 w-5'
  // dispatch click event on target element to play sound
  export let targetSelector = ''

  const MIN_DURATION = 1000

  let target = null
  let duration = 0
  // bind to elements
  let audioElement = null
  let volume1 = null
  let volume2 = null
  // animation
  let start = -1

  let durationPromise = null

  export async function play() {
    if (isDev) audioElement.play()
    else target.dispatchEvent(new MouseEvent('click'))
    await durationPromise
    animStart()
    return new Promise((resolve) => {
      setTimeout(() => resolve(), duration * 1000)
    })
  }

  function animStart() {
    start = Date.now()
    volume1.style.animation = `play 0.4s steps(4, end) infinite`
    volume2.style.animation = `play 0.4s steps(2, end) infinite`
    setTimeout(() => {
      animStop()
    }, duration * 1000)
  }

  function animStop() {
    const now = Date.now()
    const end = start + MIN_DURATION

    const stopAnimation = () => {
      volume1.style.animation = ''
      volume2.style.animation = ''
      start = -1
    }

    if (now >= end) stopAnimation()
    else {
      setTimeout(() => {
        stopAnimation()
      }, end - now)
    }
  }

  async function getAudioDuration(href) {
    audioElement = document.createElement('audio')
    audioElement.preload = 'metadata'
    audioElement.src = href.replace('playsound:', '')

    const promise = new Promise((resolve, reject) => {
      audioElement.onloadeddata = () => {
        resolve(audioElement.duration)
      }
      audioElement.onerror = () => {
        reject(0)
      }
    }) 

    return promise
  }

  onMount(async () => {
    if (!targetSelector.trim().length) return
    target = document.querySelector(targetSelector)
    durationPromise = getAudioDuration(target.href).then(newDuration => {
      duration = newDuration
    })
  })
</script>

<span
  on:click
  class={`${className} inline-flex items-center text-primary dark:text-primary-dark`}
  ><svg
    viewBox="0 0 18 16"
    xmlns="http://www.w3.org/2000/svg"
    class={`fill-current`}
  >
    <path
      d="M10.3 0.919917C10.8493 3.21298 11.1312 5.56197 11.14 7.91992C11.1539 10.1758 10.8784 12.4242 10.32 14.6099C10.2808 14.7694 10.2093 14.9192 10.11 15.0499C10.0146 15.1734 9.89565 15.2768 9.76004 15.3541C9.62444 15.4313 9.47488 15.4809 9.31998 15.4999H9.16996C8.91031 15.4999 8.6577 15.4157 8.44999 15.2599L4.75998 12.4499C4.71039 12.4409 4.65955 12.4409 4.60996 12.4499H1.96994C1.76621 12.4423 1.56774 12.3832 1.39292 12.2783C1.21809 12.1735 1.07258 12.0261 0.969944 11.8499C0.319087 10.666 -0.00532894 9.33043 0.0299416 7.97991C0.01615 6.54229 0.33802 5.12129 0.969944 3.82992C1.06823 3.62758 1.22185 3.45723 1.413 3.33865C1.60415 3.22006 1.82502 3.15809 2.04996 3.15991H4.66996C4.71894 3.15061 4.76618 3.13376 4.80997 3.10992L8.42997 0.279933C8.57072 0.182777 8.726 0.108523 8.88999 0.0599317C9.2013 -0.00998806 9.52756 0.0437908 9.79996 0.209926C10.053 0.372152 10.2325 0.627 10.3 0.919917V0.919917Z"
    />
    <path
      bind:this={volume1}
      d="M14.3602 3.94009C14.2972 3.94468 14.2358 3.96251 14.1801 3.9924C14.1244 4.02229 14.0756 4.06358 14.0369 4.11359C13.9983 4.16359 13.9705 4.22116 13.9556 4.28259C13.9406 4.34402 13.9389 4.40791 13.9503 4.47009C14.09 5.62483 14.1601 6.78694 14.1602 7.9501C14.1616 9.09004 14.0915 10.2289 13.9503 11.3601C13.9419 11.4219 13.9458 11.4848 13.9619 11.545C13.9781 11.6053 14.006 11.6617 14.0442 11.711C14.0824 11.7603 14.13 11.8016 14.1842 11.8323C14.2385 11.8631 14.2983 11.8827 14.3602 11.8901H14.4303C14.5494 11.8908 14.6644 11.8471 14.7531 11.7676C14.8418 11.6882 14.8978 11.5786 14.9102 11.4601C15.0511 10.2887 15.1213 9.10993 15.1203 7.93011C15.1207 6.73369 15.0505 5.53827 14.9102 4.3501C14.8881 4.22451 14.8189 4.11213 14.7166 4.03592C14.6144 3.9597 14.4869 3.92541 14.3602 3.94009V3.94009Z"
    />
    <path
      bind:this={volume2}
      d="M17.1602 2.54991C17.1507 2.48806 17.1287 2.42881 17.0955 2.37577C17.0622 2.32274 17.0185 2.27704 16.967 2.24146C16.9156 2.20589 16.8574 2.1812 16.796 2.16889C16.7347 2.15659 16.6714 2.15693 16.6102 2.1699C16.549 2.18073 16.4906 2.20361 16.4382 2.23719C16.3859 2.27078 16.3408 2.31439 16.3054 2.36555C16.2701 2.4167 16.2452 2.47437 16.2323 2.5352C16.2194 2.59602 16.2187 2.65879 16.2302 2.71989C16.5436 4.439 16.7042 6.18248 16.7102 7.92991C16.7089 9.62788 16.5482 11.322 16.2302 12.9899C16.2172 13.0511 16.2169 13.1143 16.2292 13.1757C16.2415 13.2371 16.2662 13.2953 16.3018 13.3468C16.3373 13.3982 16.3831 13.4419 16.4361 13.4751C16.4891 13.5083 16.5484 13.5304 16.6102 13.5399H16.7102C16.8206 13.537 16.9271 13.4985 17.0136 13.4299C17.1002 13.3614 17.1621 13.2666 17.1902 13.1599C17.5176 11.436 17.6783 9.6846 17.6702 7.92991C17.6432 6.12589 17.4727 4.32687 17.1602 2.54991V2.54991Z"
    />
  </svg></span
>
